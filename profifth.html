<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crapd.in - OnePlus 13R!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* CSS Variables for consistent theming (Dark Phone Background Theme) */
        :root {
            --primary: #121212; /* Very dark, almost black for background */
            --secondary: #212121; /* Slightly lighter dark for gradients */
            --accent: #00bfff; /* Deep Sky Blue accent */
            --light: #f5f5f5; /* Off-white for text */
            --dark: #0a0a0a; /* Even darker for body background */
            --success: #28a745; /* Standard green for success */
            --warning: #ffc107; /* Standard amber for warnings */
            --card-bg: #1e1e1e; /* Dark gray for cards */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.6); /* Stronger shadow for depth */
            --transition: all 0.3s ease;
        }

        /* Universal box-sizing and font family */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Body styling for background and text color */
        body {
            background: var(--dark);
            color: var(--light);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Main content area styling */
        main {
            padding-top: 100px; /* To account for fixed header */
            max-width: 1700px;
            margin: 0 auto;
            padding: 100px 20px 50px;
        }

        /* Lottery Stats Section */
        .lottery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: var(--transition);
            border: 1px solid rgba(0, 191, 255, 0.2); /* Accent color border */
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--accent);
        }

        .stat-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--warning); /* Amber */
        }

        .stat-card p {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--light);
        }

        /* Product Section Styling */
        .product-section {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 3rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 191, 255, 0.2); /* Accent color border */
        }

        .product-header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 1.5rem;
            text-align: center;
        }

        .product-header h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .product-content {
            display: flex;
            flex-wrap: wrap;
            padding: 2rem;
            align-items: center;
            justify-content: center;
        }

        .product-image {
            flex: 1;
            min-width: 300px;
            padding: 1rem;
        }

        .product-image img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .product-details {
            flex: 2;
            min-width: 300px;
            padding: 1rem;
        }

        .price-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 1.5rem 0;
        }

        .original-price {
            font-size: 1.8rem;
            text-decoration: line-through;
            color: #b0b0b0;
        }

        .lottery-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .features {
            margin: 1.5rem 0;
        }

        .features h3 {
            margin-bottom: 1rem;
            color: var(--warning);
        }

        .features ul {
            padding-left: 1.5rem;
        }

        .features li {
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent), #1e90ff); /* Sky Blue gradient */
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--light);
            border: 2px solid var(--secondary);
        }

        .btn-secondary:hover {
            background: rgba(0, 191, 255, 0.2);
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .product-content {
                flex-direction: column;
            }
            .product-image {
                max-width: 80%;
            }
        }

        /* Popup Styles */
        #popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 999;
        }

        .popup {
            display: none;
            background: #1a1a1a;
            color: #fff;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.4); /* Accent color shadow */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .popup input,
        .popup button,
        .popup select,
        .popup textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            border: none;
            font-size: 16px;
        }
        
        .popup input,
        .popup textarea {
            background: #f5f5f5;
            color: #000;
        }
        
        .popup textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .popup label {
            display: block;
            margin-bottom: 5px;
            color: var(--warning);
        }
        
        .popup button[type="submit"],
        .popup button#okayBtn,
        #razorpay-payment-btn,
        #downloadTicketsBtn {
            background: linear-gradient(90deg, var(--accent), #1e90ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
        }
        
        #ticketDisplay {
            font-weight: bold;
            color: #00ffcc;
            font-size: 20px;
            word-break: break-word;
            text-align: center;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin: 10px 0;
        }

        #countryError {
            color: red;
            font-size: 13px;
            display: none;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        #submitMessage {
            color: #00ffcc;
            font-size: 1.1rem;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        
        #timerDisplay {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            text-align: center;
            margin-top: 15px;
        }

        .quantity-selector {
            margin: 15px 0;
        }
        
        .quantity-selector label {
            display: block;
            margin-bottom: 8px;
            color: var(--warning);
        }
        
        .quantity-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .total-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            text-align: right;
            margin: 10px 0;
        }

        @media (max-width: 480px) {
            .popup {
                padding: 20px;
            }
            .popup input,
            .popup button,
            .popup select,
            .popup textarea {
                font-size: 14px;
                padding: 10px;
            }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            10% { opacity: 1; transform: translate(-50%, -50%); }
            90% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); display: none; }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
    </style>
</head>
<body>
  

    <main>
        
        <section class="product-section">
            <div class="product-header">
                <h2>OnePlus 13R</h2>
            </div>

            <div class="product-content">
                <div class="product-image">
                    <img src="ph2.jpg" alt="OnePlus 13R">
                </div>
                <div class="product-details">
                    <h3>OnePlus 13R: Smarter, Faster, and Built to Last.</h3>
                    <p>
                        The OnePlus 13R brings a new era of smartphone experience with its powerful performance, stunning display, and innovative features. Designed for seamless multitasking and immersive entertainment, it ensures you stay ahead in every aspect of your digital life.
                    </p>
                    
                    <div class="price-container">
                        <div class="original-price">Original Price: â‚¹39,999</div>
                        <div class="lottery-price">Access Fee: â‚¹41 per entry</div>
                    </div>
                    
                    <div class="features">
                        <h3>Key Features:</h3>
                        <ul>
                            <li>Powerful Processor for seamless performance</li>
                            <li>Vibrant AMOLED display with smooth refresh rate</li>
                            <li>High-resolution camera for stunning photos</li>
                            <li>Optimized battery for extended usage</li>
                            <li>Rapid charging technology</li>
                            <li>Sleek and premium design</li>
                            <li>Intuitive OxygenOS experience</li>
                        </ul>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="participate-btn">
                            <i class="fas fa-ticket-alt"></i> Get Access
                        </button>
                        <button class="btn btn-secondary" onclick="window.open('https://www.amazon.in/OnePlus-13R-Smarter-Lifetime-Warranty/dp/B0DPS62DYH/', '_blank')">
                            <i class="fas fa-external-link-alt"></i> View Product on Amazon
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="lottery-stats">
            <div class="stat-card">
                <h3>Total Members Needed</h3>
                <p>1000+</p>
            </div>
            <div class="stat-card">
                <h3>Start Date Is </h3>
                <p>15 August 2025</p>
            </div>
            <div class="stat-card">
                <h3>Result Date</h3>
                <p>As Soon As Reched 1000+</p>
            </div>
            <div class="stat-card">
                <h3>Member Reached  </h3>
                <p>101+</p>
            </div>
        </div>
    </main>

    <div id="popup-overlay"></div>
    
    <div class="popup" id="popupForm">
        <h2 style="text-align: center;">Get Exclusive Access</h2>
        <form id="lotteryForm">
            <input type="text" name="field1" required placeholder="Your Full Name (min 10 characters)" autocomplete="name" minlength="10" />
            <input type="tel" name="field2" required placeholder="Phone Number (10 digits)" autocomplete="tel" pattern="[0-9]{10}" />
            <input type="email" name="field3" required placeholder="Email Address" autocomplete="email" />
            
            <div>
                <label for="dobField">Date of Birth:</label>
                <input type="date" id="dobField" name="field4" required />
            </div>
            
            <input type="text" name="field5" required placeholder="City/Place (e.g. Mumbai, Delhi)" autocomplete="address-level2" list="cities" />
            
            <textarea name="field6" required placeholder="Complete Address (min 30 characters) - Include street, area, landmark, city, state, and PIN code" autocomplete="street-address" minlength="30" rows="4"></textarea>
            <span id="countryError">Please enter your complete address with at least 30 characters.</span>
            
            <div class="quantity-selector">
                <label for="ticketQuantity">Number of Entry (Max 50):</label>
                <select id="ticketQuantity" name="ticketQuantity" required>
                    <option value="" disabled selected>Select quantity</option>
                    </select>
                <div class="quantity-info">
                    <span>â‚¹41 per Entry</span>
                    <span class="total-price">Total: â‚¹0</span>
                </div>
            </div>
            
            <input type="hidden" name="ticket" id="ticketCode" />
            <button type="submit">Submit Details</button>
            <span id="submitMessage">Submitting... Please wait</span>
        </form>
    </div>

    <div class="popup" id="paymentStep">
        <h2>Complete Your Payment</h2>
        <p>Please complete the payment to finalize your Entry ticket purchase. Click the button below.</p>
        <div id="paymentSummary"></div>
        <div id="timerDisplay">Time remaining: 05:00</div>
        <button id="razorpay-payment-btn">Pay with Razorpay</button>
        <p style="margin-top: 10px; font-size: 0.9em; color: #ccc;">
            After payment, please wait for automatic verification. Do not close this window.
        </p>
    </div>

    <div class="popup" id="ticketStep">
        <h2>ðŸŽ‰ Congratulations! Your Entry Ticket are Ready! ðŸŽ‰</h2>
        <p>You have purchased <span id="ticketCountDisplay"></span>:</p>
        <div id="ticketDisplay"></div>
        <button id="downloadTicketsBtn"><i class="fas fa-download"></i> Download Tickets as Text File</button>
        <p style="margin-top: 15px;">ðŸ“¸ Please take a screenshot for proof and reference.</p>
        <button id="okayBtn">Okay, Got It!</button>
    </div>
   
    <script>
        // Popup Elements
        const participateBtn = document.getElementById('participate-btn');
        const popupOverlay = document.getElementById('popup-overlay');
        const allPopups = document.querySelectorAll('.popup');
        const popupForm = document.getElementById('popupForm');
        const paymentStep = document.getElementById('paymentStep');
        const ticketStep = document.getElementById('ticketStep');
        const timerDisplay = document.getElementById('timerDisplay');
        const razorpayBtn = document.getElementById('razorpay-payment-btn');
        const submitMessage = document.getElementById('submitMessage');
        const ticketQuantity = document.getElementById('ticketQuantity');
        const totalPriceDisplay = document.querySelector('.total-price');
        const paymentSummary = document.getElementById('paymentSummary');
        const ticketCountDisplay = document.getElementById('ticketCountDisplay');
        const downloadTicketsBtn = document.getElementById('downloadTicketsBtn');

        // Form & Ticket Elements
        const form = document.getElementById('lotteryForm');
        const ticketInput = document.getElementById('ticketCode');
        const ticketDisplay = document.getElementById('ticketDisplay');
        const okayBtn = document.getElementById('okayBtn');

        let generatedTickets = [];
        let paymentTimeout = null;
        let countdownInterval = null;
        const PAYMENT_TIME_LIMIT = 5 * 60; // 5 minutes in seconds
        const TICKET_PRICE = 41; // Price per ticket set to â‚¹41
        let selectedQuantity = 1;
        let allowClose = false; // Flag to control when popup can be closed

        // Initialize quantity selector
        function initQuantitySelector() {
            const maxTickets = 50;
            ticketQuantity.innerHTML = '<option value="" disabled selected>Select quantity</option>';
            
            for (let i = 1; i <= maxTickets; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + (i === 1 ? ' entry' : ' entries');
                ticketQuantity.appendChild(option);
            }
            
            // Set default value to 1
            ticketQuantity.value = 1;
            updateTotalPrice();
        }

        // Update total price display
        function updateTotalPrice() {
            selectedQuantity = parseInt(ticketQuantity.value) || 1;
            const total = selectedQuantity * TICKET_PRICE;
            totalPriceDisplay.textContent = `Total: â‚¹${total}`;
        }

        // Generate multiple tickets with incrementing last 2 digits
        function generateFormattedTickets(...fields) {
            generatedTickets = [];
            const tickets = [];
            
            // Generate a base ticket code
            const uniqueFields = [...fields, Date.now()];
            const base = btoa(uniqueFields.join('')).replace(/[^A-Z0-9]/gi, '').toUpperCase();
            let raw = base.padEnd(20, 'X').substring(0, 18); // Take first 18 characters to leave room for 2-digit suffix
            
            // Generate tickets with incrementing last 2 digits
            for (let i = 0; i < selectedQuantity; i++) {
                // Calculate last 2 digits (starting from 5 and incrementing)
                const lastTwoDigits = (5 + i).toString().padStart(2, '0');
                // Combine with the base
                const ticket = (raw + lastTwoDigits).match(/.{1,4}/g).join('-');
                generatedTickets.push(ticket);
                tickets.push(ticket);
            }
            
            return tickets.join(', '); // Return all tickets as comma-separated string
        }

        // Download tickets as text file
        function downloadTickets() {
            const ticketContent = generatedTickets.join('\n\n');
            const blob = new Blob([ticketContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my_lottery_tickets.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- FUNCTIONS TO CONTROL POPUPS ---
        function closeAllPopups() {
            if (!allowClose) return; // Only close if allowed
            
            clearTimers();
            popupOverlay.style.display = 'none';
            allPopups.forEach(p => p.style.display = 'none');
            document.body.style.overflow = 'auto';
            submitMessage.style.display = 'none';
            allowClose = false; // Reset the flag
        }

        function openPopup(popupElement) {
            document.body.style.overflow = 'hidden';
            popupOverlay.style.display = 'block';
            popupElement.style.display = 'block';
            allowClose = false; // Don't allow closing when opening a new popup
        }

        function clearTimers() {
            if (paymentTimeout) clearTimeout(paymentTimeout);
            if (countdownInterval) clearInterval(countdownInterval);
            paymentTimeout = null;
            countdownInterval = null;
        }

        // --- EVENT LISTENERS ---
        participateBtn.addEventListener('click', () => {
            initQuantitySelector();
            openPopup(popupForm);
        });
        
        ticketQuantity.addEventListener('change', updateTotalPrice);
        
        // Modified overlay click handler
        popupOverlay.addEventListener('click', function(e) {
            if (allowClose) {
                closeAllPopups();
            } else {
                showCustomAlert("Please complete the form or payment process before closing.");
            }
        });
        
        allPopups.forEach(p => p.addEventListener('click', e => e.stopPropagation()));
        
        // MODIFIED: Redirect to index.html on "Okay, Got It!" click
        okayBtn.addEventListener('click', function() {
            window.location.href = 'index.html'; 
        });
        
        razorpayBtn.addEventListener('click', handleRazorpayPayment);
        downloadTicketsBtn.addEventListener('click', downloadTickets);

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const data = {
                field1: form.field1.value.trim(),
                field2: form.field2.value.trim(),
                field3: form.field3.value.trim(),
                field4: form.field4.value,
                field5: form.field5.value.trim(),
                field6: form.field6.value.trim(),
                quantity: selectedQuantity
            };

            // Validate name (min 10 characters)
            if (data.field1.length < 10) {
                showCustomAlert("Please enter your full name (minimum 10 characters)");
                return;
            }

            // Validate phone (exactly 10 digits)
            if (!/^\d{10}$/.test(data.field2)) {
                showCustomAlert("Please enter a valid 10-digit phone number");
                return;
            }

            // Validate email
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.field3)) {
                showCustomAlert("Please enter a valid email address");
                return;
            }

            // Validate date of birth
            if (!data.field4) {
                showCustomAlert("Please select your date of birth");
                return;
            }

            // Validate city/place
            if (data.field5.length < 3) {
                showCustomAlert("Please enter a valid city/place name");
                return;
            }

            // Validate address (min 30 characters)
            if (data.field6.length < 30) {
                document.getElementById('countryError').style.display = 'block';
                showCustomAlert("Please enter a complete address with at least 30 characters.");
                return;
            }
            document.getElementById('countryError').style.display = 'none';

            submitMessage.style.display = 'block';
            form.querySelector('button[type="submit"]').disabled = true;

            data.ticket = generateFormattedTickets(...Object.values(data));
            data.tab = "productfive";  // Changed to productfive
            ticketInput.value = data.ticket;

            const urlEncoded = new URLSearchParams(data);

            fetch(
                "https://script.google.com/macros/s/AKfycbz-jThD5sdFPFV3l-_6G6NBdTeOiSg7uqOv7X1BgxX1oO0vg0BEwJMlWdH2i7EmWEgjOw/exec", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: urlEncoded
                }
            ).then(res => res.text()).then(res => {
                submitMessage.style.display = 'none';
                form.querySelector('button[type="submit"]').disabled = false;

                if (res === "Success") {
                    popupForm.style.display = 'none';
                    openPopup(paymentStep);
                    paymentSummary.innerHTML = `
                        <p>You are purchasing ${selectedQuantity} entry${selectedQuantity > 1 ? 's' : ''} at â‚¹${TICKET_PRICE} each</p>
                        <p class="total-price">Total Amount: â‚¹${selectedQuantity * TICKET_PRICE}</p>
                    `;
                    startPaymentTimer();
                } else {
                    console.error("Submission failed: " + res);
                    showCustomAlert("There was an error submitting your form. Please try again.");
                }
            }).catch(err => {
                submitMessage.style.display = 'none';
                form.querySelector('button[type="submit"]').disabled = false;
                console.error("An unexpected error occurred. Please check your connection and try again:", err);
                showCustomAlert("An unexpected error occurred. Please check your connection and try again.");
            });
        });
        
        function showCustomAlert(message) {
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--accent);
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                z-index: 1002;
                box-shadow: 0 5px 15px rgba(0,0,0,0.4);
                font-size: 1.1rem;
                text-align: center;
                max-width: 80%;
                animation: fadeInOut 4s forwards;
            `;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            const styleSheet = document.createElement('style');
            styleSheet.type = 'text/css';
            styleSheet.innerText = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -40%); }
                    10% { opacity: 1; transform: translate(-50%, -50%); }
                    90% { opacity: 1; transform: translate(-50%, -50%); }
                    100% { opacity: 0; transform: translate(-50%, -60%); display: none; }
                }
            `;
            document.head.appendChild(styleSheet);

            setTimeout(() => {
                alertBox.remove();
                styleSheet.remove();
            }, 4000);
        }

        // --- RAZORPAY PAYMENT HANDLING ---
        function handleRazorpayPayment() {
            const totalAmount = selectedQuantity * TICKET_PRICE * 100; // Convert to paise
            
            const options = {
                "key": "rzp_live_zyUA84YdEZR7rO", // Replace with your actual Razorpay Key ID
                "amount": totalAmount.toString(),
                "currency": "INR",
                "name": "crapd.in",
                "description": `Payment for ${selectedQuantity} Orderd Items${selectedQuantity > 1 ? 's' : ''}`,
                "image": "https://placehold.co/100x100/00bfff/ffffff?text=C", // Placeholder logo with new color
                "handler": function (response){
                    console.log("Payment successful:", response);
                    console.log("Razorpay Payment ID:", response.razorpay_payment_id);
                    paymentSuccess();
                },
                "prefill": {
                    "name": form.field1.value,
                    "email": form.field3.value.trim(),
                    "contact": form.field2.value
                },
                "notes": {
                    "address": `${form.field5.value}, ${form.field6.value}`,
                    "ticket_count": selectedQuantity.toString()
                },
                "theme": {
                    "color": "#00bfff"
                },
                "modal": {
                    "ondismiss": function(){
                        console.log('Razorpay checkout modal closed.');
                    }
                }
            };

            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response){
                console.error("Payment Failed:", response.error);
                showCustomAlert(`Payment Failed: ${response.error.description} (Code: ${response.error.code})`);
            });
            rzp1.open();
        }

        function startPaymentTimer() {
            let timeLeft = PAYMENT_TIME_LIMIT;
            updateTimerDisplay(); // Initial display

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `Time remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            countdownInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    showCustomAlert("Payment time expired. Please try again.");
                    allowClose = true; // Allow closing after timeout
                    closeAllPopups();
                }
            }, 1000);

            paymentTimeout = setTimeout(() => {
                if (paymentTimeout) {
                    clearTimers();
                    showCustomAlert("Payment timed out. Please try again.");
                    allowClose = true; // Allow closing after timeout
                    closeAllPopups();
                }
            }, PAYMENT_TIME_LIMIT * 1000);
        }

        function paymentSuccess() {
            clearTimers();
            paymentStep.style.display = 'none';
            openPopup(ticketStep);
            
            // Display all tickets
            ticketDisplay.textContent = generatedTickets.join('\n\n');
            ticketCountDisplay.textContent = `${selectedQuantity} entry${selectedQuantity > 1 ? 's' : ''}`;
            
            // Allow closing only from the ticket step
            allowClose = false;
        }
    </script>
</body>
</html>
